# Add automatic IPv6 configuration for certain standard services

[Add-family-inet6.slax](https://github.com/jumation/add-family-inet6/blob/master/add-family-inet6.slax) is a Junos commit script which automatically configures the IPv6 address according to IPv6 address plan and inet6 family in general for certain standard services during the commit process. This means, that the network engineer needs to configure IPv4 address only. IPv6 part is done automatically.

## Overview

Let's say, that according to company IPv6 address plan:

![IPv6 address plan](https://github.com/jumation/add-family-inet6/blob/master/IPv6_address_plan.png)

..the direct Internet access(DIA) customers get a /64 prefix from a /48 based on following schema:
```
2001:db8:SS01:TVVV::/64
````

* `2001:db8::/32` is a RIR allocation
* `SS` is an eight bits long site ID
* `01` is a per-site `DIA customers` [AGGREGATED-BY-LIR](https://www.ripe.net/publications/docs/ripe-513) /48 with assignment-size of 64
* `T` is 4 bits long DIA type ID. For example, regular direct Internet access is `0`, management connections are `1`, VRRP DIA connections could be `2`, etc.
* `VVV` is a 12 bits long field containing the VLAN ID in hex

Each DIA service is provided using a per-site unique VLAN ID.

*Example of add-family-inet6.slax dynamically expanding the DIA service configuration during the commit process:*

![DIA service commit screenshot](https://github.com/jumation/add-family-inet6/blob/master/DIA_commit_example.png)

As seen above, `family inet6` and `router-advertisement` configuration is dynamically added. `SS` bits(`01` in the example above) in the IPv6 address are from the aggregate route:
```
root@DC2-r1> show configuration routing-options rib inet6.0 
aggregate {
    /* Assignment for DC2 */
    route 2001:db8:100::/40 {
        community [ 64496:1122 64496:3344 ];
        as-path {
            origin igp;
        }
        discard;
        active;
    }
}

root@DC2-r1> 
```

`T` bits are `0` because the service type is `DIA`. As `vlan-id` is 123, then `VVV` bits are `07b` which is 123 in hex. General customer-facing port configuration like IPFIX sampling, MTU/MRU, RPF check, custom ARP policer for `family inet`, etc is from a group applied under `[edit interfaces]`:
```
root@DC2-r1> show configuration groups __int-default__    
interfaces {
    ae0 {
        unit <*> {
            family inet {
                rpf-check;
                mtu 1500;
                policer {
                    arp arp-policer;
                }
                sampling {
                    input;
                }
            }
            family inet6 {
                rpf-check;
                mtu 1500;
                sampling {
                    input;
                }
            }
        }
    }
}
                                        
root@DC2-r1> 
```

*Example of add-family-inet6.slax dynamically expanding the MGMT-DIA service configuration during the commit process:*

![MGMT-DIA service commit screenshot](https://github.com/jumation/add-family-inet6/blob/master/MGMT-DIA_commit_example.png)

In the example above, the `T` bits are `1` because the service type is `MGMT-DIA`. `VVV` bits are `8b9` which is 2233 in hex. In addition, the same aggregate policer(automatically generated by another commit script) applied to `family inet` is also automatically configured to `family inet6`. In addition, by default, all IPv6 egress traffic towards the customer is dropped in case of `MGMT-DIA` service and SLAAC is not enabled.


## Installation

Copy(for example, using [scp](https://en.wikipedia.org/wiki/Secure_copy)) the [add-family-inet6.slax](https://github.com/jumation/add-family-inet6/blob/master/add-family-inet6.slax) to `/var/db/scripts/commit/` directory and enable the script file under `[edit system scripts commit]`:

```
root@DC2-r1> file list detail /var/db/scripts/commit/add-family-inet6.slax          
-rw-r--r--  1 martin wheel      5125 Nov 26 20:30 /var/db/scripts/commit/add-family-inet6.slax
total files: 1

root@DC2-r1> show configuration system scripts | display inheritance no-comments    
commit {
    file add-family-inet6.slax {
        checksum sha-256 3519c29f7a894cf871a7316828885f86fc5a6ee117d0b5067f1b49777d8f83aa;
    }
}
synchronize;

root@DC2-r1> 
```

In case of two routing engines, the script needs to be copied to the `/var/db/scripts/commit/` directory on both routing engines.


## License
[GNU General Public License v3.0](https://github.com/jumation/add-family-inet6/blob/master/LICENSE)
